# 로그인 리다이렉트 구조 변경 사항 점검 결과

아래는 제공된 최신 코드 스냅샷 기준으로 “로그인 전 URL 보존 → OAuth state로 전달 → 콜백에서 복원 → 팝업/일반 모두 복귀” 흐름이 올바르게 연결되었는지 컴포넌트/엔드포인트별로 검증한 결과와 보완 권고 사항입니다.

## 백엔드 점검

### 1) /auth/kakao/url: state 반영

- 변경 사항
    - state: Optional[str] 파라미터 수용
    - sanitize_return_url(state) 후 카카오 authorize URL의 state에 반영
    - 기본값 “/”로 처리
- 평가
    - 의도대로 구현됨. 반환 JSON 스키마도 기존과 동일(login_url)이라 하위 호환성 보장.
- 권고
    - sanitize_return_url이 반드시 “/” 시작 상대경로만 허용하도록 구현되어야 함. 현재 utils.validators.sanitize_return_url이 실제로 그렇게 구현되어 있는지 확인 필요.
    - state 길이 제한(예: 1024)도 sanitize 함수에 포함되어 있으면 더 안전.


### 2) /auth/kakao/callback: state 전달

- 변경 사항
    - state 쿼리 파라미터 수용, sanitize 후 cleaned_state 로컬 변수 보관
    - 성공 시 FRONTEND_URL/auth/callback/success?state=cleaned_state 로 302
    - 실패 시 FRONTEND_URL/auth/callback/fail?reason=...\&state=cleaned_state 로 302
    - 쿠키 설정(AT/RT) 시점은 리다이렉트 Response에 세팅 → OK
- 평가
    - 정합성 양호. 프론트가 state를 받아 리디렉션 목적지 복원 가능.
- 권고
    - 로깅 시 state 원문 노출을 피하거나 마스킹 추천.


### 3) 기타

- /auth/verify, /auth/me 등 기존 엔드포인트는 변경 없이 정상.
- 결론
    - 백엔드 측 “state 체인 유지” 구현은 올바르게 반영됨.


## 프론트엔드 점검

공통: pathUtils 사용 흔적이 있으므로 다음 유틸이 존재해야 함

- ensureSafePath(path): “/” 시작 상대경로 보장, 아니면 “/” 반환
- resolveReturnUrlForLogin(): 쿼리 → 세션 → 현재 경로 순으로 returnUrl 결정
- storeReturnUrl(path), getStoredReturnUrl(): sessionStorage 연동

현재 스냅샷에는 pathUtils 소스는 없지만 import 사용은 일관되어 있음. 실제 구현 누락 시 런타임 에러가 발생하므로 반드시 존재 확인 필요.

### 1) ProtectedRoute.tsx

- 변경 사항
    - useLocation 훅 사용, isLoading일 때 로딩 UI
    - 미인증 시 storeReturnUrl 호출 후 Navigate to /login?returnUrl=...
- 평가
    - storeReturnUrl 호출은 보이지만 해당 코드 블록과 Navigate 렌더링 부분이 스니펫에 일부만 표시되어 전체 조건이 완전히 보이지 않음.
- 권고
    - 최종 형태가 다음과 같은지 확인
        - if (!isAuthenticated \&\& !isLoading) { storeReturnUrl(currentPathWithQueryAndHash); return <Navigate to={`/login?returnUrl=${encodeURIComponent(current)}`} replace /> }
        - 이미 /login인 경우 루프 방지
    - storeReturnUrl 호출 시 location.pathname + location.search + location.hash 모두 포함.


### 2) LoginPage.tsx

- 제공 스냅샷 없음.
- 권고
    - 존재한다면 mount 시 searchParams.returnUrl를 ensureSafePath로 검증 후 sessionStorage에 반영해 KakaoLoginButton의 resolveReturnUrlForLogin과 정합성 유지.


### 3) KakaoLoginButton.tsx

- 변경 사항
    - resolveReturnUrlForLogin()으로 returnUrl 결정 → storeReturnUrl(returnUrl) 저장
    - /auth/kakao/url?state=encoded(returnUrl) 호출 후 팝업 오픈
    - 팝업 메시지(KAKAO_LOGIN_SUCCESS) 수신 시 await login() → user 데이터로 신규 여부 판단
    - 신규면 /profile, 기존이면 getStoredReturnUrl() → ensureSafePath → window.location.href
- 평가
    - OAuth state 전달과 팝업 모드 복귀 로직 모두 적절.
    - 팝업 성공 시 부모창이 returnUrl을 활용하는 플로우가 구현되어 있음.
- 권고
    - 팝업 에러/타임아웃 처리 로직은 기존 유지로 충분.
    - ensureSafePath 결과가 falsy일 경우를 대비해 기본값 “/”를 내장시키는 것도 안전.


### 4) KakaoCallbackPage.tsx

- 변경 사항
    - success/fail 양쪽 모두 location.search의 state를 디코드 후 storeReturnUrl로 저장
    - /auth/verify → /auth/me 성공 후:
        - 팝업: 부모창에 KAKAO_LOGIN_SUCCESS 송신
        - 일반: await login(); 신규면 /profile, 아니면 getStoredReturnUrl() → ensureSafePath → navigate(targetUrl)
    - 실패 시에도 stateParam이 있으면 storeReturnUrl으로 유지 → 이후 /login?returnUrl=... 로 유도
- 평가
    - 일반 모드 복귀 로직, 실패 시 returnUrl 유지 모두 좋음.
    - decodeURIComponent(stateParam) 후 storeReturnUrl 하는데, stateParam은 백엔드가 sanitize한 상대경로이므로 안전 측면에서 추가 ensureSafePath(stateParam) 후 저장하는 편이 더 일관됨.
- 권고
    - storeReturnUrl(decodedReturnUrl) 전에 ensureSafePath 적용 권장.
    - 사용자 신규 정책은 “프로필 우선”으로 명확히 반영되어 일관적임.


### 5) AuthProvider.tsx / useAuth

- 변경 사항
    - isNewUser 상태 추가 및 /auth/me 응답으로 판단
- 평가
    - KakaoCallbackPage에서 userRes로 다시 판단하므로 기능 겹침은 있지만 문제는 없음.
- 권고
    - isNewUser가 중앙에서 제공되므로 KakaoCallbackPage에서도 useAuth의 isNewUser를 재사용해도 됨. 다만 현 상태도 무방.


### 6) success.tsx, fail.tsx

- success.tsx
    - 현재는 단순히 login() 후 “/”로 이동. 새 구조(state 기반 복귀)와는 달리 returnUrl을 사용하지 않음.
    - 실제 라우팅은 /auth/callback/success가 KakaoCallbackPage로 매핑되어 있으므로 success.tsx는 사용되지 않는 것으로 보임.
- fail.tsx
    - 5초 후 /login으로 이동. fail 콜백 라우팅이 fail.tsx가 아닌 KakaoCallbackPage에 매핑되어 있어, 실제 사용되지 않을 가능성 큼.
- 평가
    - 라우터 설정상 success/fail 경로 모두 KakaoCallbackPage를 사용하므로 success.tsx/fail.tsx는 미사용 리소스로 보임.
- 권고
    - 라우터에서 success/fail에 별도 컴포넌트를 쓰지 않는다면 해당 파일은 제거하거나 주석으로 “미사용” 표기.
    - 만약 분리 유지 의도면 라우터에서 success → KakaoCallbackSuccess, fail → KakaoCallbackFail로 명시 매핑 변경 후 내부에서도 state/returnUrl 반영 필요.


### 7) 라우터

- /auth/callback/success, /auth/callback/fail 모두 KakaoCallbackPage로 연결되어 있음.
- 평가
    - 단일 콜백 컴포넌트로 success/fail을 처리하는 구조가 유지되어 일관적.
- 권고
    - /kakao/callback, /api/auth/kakao/callback 라우트는 실제로 필요하지 않다면 제거 검토. 유지 시에도 KakaoCallbackPage로 일관 처리되니 문제는 없음.
    - 서버 측 SPA 리라이트 설정 점검하여 404 회피.


## 시나리오별 동작 검증

- 보호 라우트 직접 접근 → /login?returnUrl=... → 카카오 로그인 시작(state=returnUrl) → 백엔드 success?state=... → KakaoCallbackPage에서 /auth/verify→/auth/me OK → 일반 모드: 신규 /profile, 기존 ensureSafePath(getStoredReturnUrl())로 복귀
    - OK
- 팝업 로그인:
    - 로그인 버튼이 returnUrl을 세션에 저장하고 팝업 오픈 → 콜백 페이지 팝업에서 parent로 success 메시지 → 부모창은 getStoredReturnUrl()으로 이동
    - OK
- 실패 플로우:
    - fail 리다이렉트에 state 포함 → KakaoCallbackPage가 state를 storeReturnUrl로 유지 → /login?returnUrl=... 유도
    - OK
- 악성 state/returnUrl:
    - 백엔드 sanitize로 1차 차단
    - 프론트 ensureSafePath로 2차 차단
    - OK


## 누락/개선 포인트 요약

- pathUtils 구현 확인
    - ensureSafePath, resolveReturnUrlForLogin, storeReturnUrl, getStoredReturnUrl가 실제로 존재하고 의도대로 동작해야 함.
    - ensureSafePath는 “/” 시작, “//” 금지, 절대 URL 금지, 길이 제한 등을 포함.
- KakaoCallbackPage에서 stateParam 저장 시 ensureSafePath 적용 권장
    - 현재는 decode만 하고 저장. 안전을 위해 storeReturnUrl(ensureSafePath(decoded)) 형태 추천.
- ProtectedRoute.tsx의 최종 조건 및 Navigate 반환부 확인
    - 스니펫이 중간에서 끊겨있어 최종 구현 확인 필요.
    - /login 페이지에서 다시 /login으로 보내지 않도록 방지 로직 포함 권장.
- success.tsx / fail.tsx 정리
    - 현재 라우팅에서 미사용. 제거 또는 라우팅 변경.
- 신규 사용자 정책 안내
    - 신규 사용자는 /profile로 이동하도록 구현되어 있음. UX 측면에서 이후 원래 returnUrl로의 이동 안내(배너/토스트) 여부는 정책에 따라 추가 가능.


## 결론

- 백엔드: state 전달/복원 흐름이 목표대로 잘 반영됨. sanitize_return_url만 정확히 구현되어 있으면 충분히 안전하고 일관됨.
- 프론트엔드: KakaoLoginButton, KakaoCallbackPage, ProtectedRoute의 핵심 변경이 들어가 전체 플로우가 의도대로 작동할 구조입니다. 다만
    - pathUtils 실제 구현 존재/검증
    - KakaoCallbackPage에서 state 저장 시 ensureSafePath 적용
    - ProtectedRoute 최종 리디렉션 반환부 확인
    - 미사용 success.tsx/fail.tsx 정리
를 마무리하면 “로그인 전 URL 보존 → 로그인 성공 후 해당 경로 복귀”가 팝업/일반 모두 안정적으로 동작할 것으로 판단됩니다.
<span style="display:none">[^1][^10][^11][^12][^13][^14][^15][^2][^3][^4][^5][^6][^7][^8][^9]</span>

<div style="text-align: center">⁂</div>

[^1]: auth.py

[^2]: auth_service.py

[^3]: axiosInstance.ts

[^4]: KakaoLoginButton.tsx

[^5]: AuthContext.ts

[^6]: AuthProvider.tsx

[^7]: useAuth.ts

[^8]: ConditionalRoute.tsx

[^9]: ProtectedRoute.tsx

[^10]: DashboardLayout.tsx

[^11]: index.ts

[^12]: ReactRouter.router.ts

[^13]: fail.tsx

[^14]: KakaoCallbackPage.tsx

[^15]: success.tsx

